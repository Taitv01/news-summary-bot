name: News Summary Bot

on:
  # Cho phép chạy thủ công từ tab Actions
  workflow_dispatch:
  
  # Lên lịch chạy tự động
  schedule:
    # Chạy vào phút thứ 0 của mỗi giờ (ví dụ: 7:00, 8:00, 9:00...)
    - cron: '0 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Bước 1: Lấy mã nguồn từ repository về máy ảo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Bước 2: Cài đặt môi trường Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Bước 3: Cài đặt các thư viện cần thiết
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Bước 4: Chạy script chính của bot
      - name: Run news bot script
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python main.py

      # Bước 5: Lưu lại file processed_links.txt nếu có thay đổi
      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # Chỉ thực hiện các lệnh tiếp theo nếu file processed_links.txt tồn tại
          if [ -f "processed_links.txt" ]; then
            git add processed_links.txt
            # Chỉ commit và push nếu có sự thay đổi trong file đã được thêm vào
            git diff --staged --quiet || (git commit -m "Update processed links" && git push)
          else
            echo "Không có file processed_links.txt mới, bỏ qua bước commit."
          fi
