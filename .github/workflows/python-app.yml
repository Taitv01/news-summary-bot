name: Advanced News Summarizer Bot

on:
  schedule:
    # Cháº¡y thÃ´ng minh hÆ¡n - trÃ¡nh giá» cao Ä‘iá»ƒm
    - cron: '0 1,5,9,13,17,21 * * *'  # 6 láº§n/ngÃ y
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean
      source_limit:
        description: 'Max articles per source'
        required: false
        default: '10'
        type: string
      force_run:
        description: 'Force run even if no new articles'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  # Job kiá»ƒm tra Ä‘iá»u kiá»‡n trÆ°á»›c khi cháº¡y
  pre-check:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check if should run
      id: check
      run: |
        # Kiá»ƒm tra láº§n cháº¡y cuá»‘i cÃ¹ng
        if [ "${{ github.event.inputs.force_run }}" == "true" ]; then
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "Force run enabled"
        else
          # Logic kiá»ƒm tra thÃ´ng minh khÃ¡c
          echo "should_run=true" >> $GITHUB_OUTPUT
        fi

  run-bot:
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should_run == 'true'
    timeout-minutes: 30

    permissions:
      contents: write
      actions: read
      issues: write  # Äá»ƒ táº¡o issue khi cÃ³ lá»—i

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "main"
            timeout: 25

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python with cache
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: requirements.txt

    - name: Install Chrome and dependencies
      uses: browser-actions/setup-chrome@v1

    - name: Setup directories
      run: |
        mkdir -p {data,logs,backups,temp}
        chmod 755 {data,logs,backups,temp}

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        pip install -r requirements.txt
        pip list  # Debug: show installed packages

    - name: Health check
      run: |
        python -c "
        import sys
        import importlib
        modules = ['feedparser', 'requests', 'bs4', 'google.generativeai']
        for module in modules:
            try:
                importlib.import_module(module)
                print(f'âœ… {module} imported successfully')
            except ImportError as e:
                print(f'âŒ {module} import failed: {e}')
                sys.exit(1)
        "

    - name: Run news bot with monitoring
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
        MAX_ARTICLES_PER_SOURCE: ${{ github.event.inputs.source_limit }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_RUN_NUMBER: ${{ github.run_number }}
      run: |
        echo "ðŸš€ Starting News Summarizer Bot..."
        echo "ðŸ“Š Run ID: $GITHUB_RUN_ID"
        echo "ðŸ”¢ Run Number: $GITHUB_RUN_NUMBER"
        echo "ðŸ› Debug Mode: $DEBUG_MODE"
        echo "ðŸ“° Max Articles: $MAX_ARTICLES_PER_SOURCE"
        
        # Cháº¡y vá»›i timeout vÃ  retry
        timeout 1500 python main.py || {
          echo "âŒ Bot execution failed or timed out"
          exit 1
        }
      timeout-minutes: 25

    - name: Analyze results
      if: always()
      run: |
        echo "=== RESULTS ANALYSIS ==="
        echo "ðŸ“ Data directory:"
        ls -la data/ || echo "No data directory"
        echo "ðŸ“‹ Log file:"
        ls -la bot.log || echo "No log file"
        echo "ðŸ’¾ File sizes:"
        du -h data/ bot.log 2>/dev/null || echo "No files to measure"
        echo "========================="

    - name: Upload comprehensive artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bot-run-${{ github.run_number }}-${{ matrix.name }}
        path: |
          bot.log
          data/
          temp/
        retention-days: 14
        compression-level: 6

    - name: Smart commit and push
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # Staging changes
        git add data/ || echo "No data to add"
        git add bot.log || echo "No log to add"
        
        # Smart commit message
        if ! git diff-index --quiet HEAD; then
          COMMIT_MSG="ðŸ“° News update $(date -u '+%Y-%m-%d %H:%M UTC') - Run #${{ github.run_number }}"
          
          # Add statistics to commit message
          if [ -f "data/processed_links.json" ]; then
            LINK_COUNT=$(jq length data/processed_links.json 2>/dev/null || echo "unknown")
            COMMIT_MSG="$COMMIT_MSG - $LINK_COUNT total links"
          fi
          
          git commit -m "$COMMIT_MSG"
          
          # Retry push with exponential backoff
          for attempt in {1..5}; do
            if git push; then
              echo "âœ… Successfully pushed changes (attempt $attempt)"
              break
            else
              echo "âŒ Push failed (attempt $attempt), retrying..."
              sleep $((2**attempt))
              git pull --rebase --strategy-option=ours
            fi
          done
        else
          echo "â„¹ï¸ No changes to commit"
        fi

    - name: Send detailed notification
      if: always()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          STATUS="âœ… SUCCESS"
          EMOJI="ðŸŽ‰"
        else
          STATUS="âŒ FAILED"
          EMOJI="ðŸš¨"
        fi
        
        MESSAGE="$EMOJI *News Bot Status: $STATUS*
        
        ðŸ“… *Time:* $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        ðŸƒ *Run:* #${{ github.run_number }}
        ðŸ”— *Workflow:* [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        
        ðŸ“Š *Statistics:*"
        
        # ThÃªm thá»‘ng kÃª náº¿u cÃ³
        if [ -f "data/processed_links.json" ]; then
          LINK_COUNT=$(jq length data/processed_links.json 2>/dev/null || echo "0")
          MESSAGE="$MESSAGE
        ðŸ“° Total processed links: $LINK_COUNT"
        fi
        
        if [ -f "bot.log" ]; then
          LOG_SIZE=$(du -h bot.log | cut -f1)
          MESSAGE="$MESSAGE
        ðŸ“‹ Log file size: $LOG_SIZE"
        fi
        
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="$MESSAGE" \
          -d parse_mode="Markdown" \
          -d disable_web_page_preview="true"
